<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>Officer Dashboard</title>

    <!-- ✅ BOOTSTRAP CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        /* Your existing custom CSS here, unchanged */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #f4f7ff; color: #333; padding: 30px; }
        .header { background: linear-gradient(135deg, #1d3557, #457b9d); padding: 20px 40px; color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .profile { display: flex; align-items: center; }
        .profile-circle { width: 40px; height: 40px; background-color: #a8dadc; border-radius: 50%; margin-right: 10px; }
        h1, h2 ,h3 { color: #1d3557; }
        .nav-container { margin-top: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; align-items: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .logout-form button { background-color: #e63946; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        table { width: 100%; margin-top: 40px; border-collapse: collapse; background-color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-radius: 12px; overflow: hidden; }
        th, td { padding: 16px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #1d3557; color: white; }
        .accepted { color: #2a9d8f; font-weight: bold; }
        .rejected { color: #e63946; font-weight: bold; }
        .upload-section { margin-top: 40px; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .submit-btn { background-color: #1d3557; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .submit-btn:hover { background-color: #457b9d; }
        .upload-section input[type="file"] { margin-bottom: 15px; }
        .file-preview { display: flex; align-items: center; gap: 10px; font-size: 1rem; margin-bottom: 20px; }
        .file-preview i { font-size: 1.5rem; color: #1d3557; }
        .upload-fields input { margin-bottom: 10px; padding: 10px; width: 100%; border-radius: 6px; border: 1px solid #ccc; }
        @media (max-width: 768px) {
            body { padding: 15px; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .logout-form button { width: 100%; }
            form, table { width: 100%; overflow-x: auto; }
            form input, form select, .submit-btn { font-size: 16px; }
            th, td { padding: 8px; font-size: 14px; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Officer Dashboard</h1>
    <div class="profile">
        <div class="profile-circle"></div>
        <span>Welcome <strong th:text="${#authentication.name}">User</strong></span>
    </div>
</div>

<div class="nav-container">
    <form class="logout-form" th:action="@{/logout}" method="post">
        <button type="submit">Logout</button>
    </form>
</div>

<!-- ✅ ALERT BOX -->
<div id="alertBox" class="alert alert-danger d-none mt-3" role="alert">
    <!-- Message will be inserted via JS -->
</div>

<h2>Upload Invoice File</h2>
<div class="upload-section">
    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.jpg,.png" />
    <div class="file-preview">
        <span class="file-icon"><i class="fas fa-file"></i></span>
        <span class="file-name">No file selected</span>
    </div>

    <form th:action="@{/user/invoice/submit}" th:object="${invoiceForm}" method="post">
        <div class="upload-fields">
            <h3><label>Invoice No</label></h3>
            <input type="text" id="invoiceNo" th:field="*{invoiceNo}" readonly>
            <h3><label>Vendor Name</label></h3>
            <input type="text" id="vendorName" th:field="*{vendorName}" readonly>
            <h3><label>Invoice Date</label></h3>
            <input type="text" id="invoiceDate" th:field="*{invoiceDate}" readonly>
            <h3><label>Item Description</label></h3>
            <input type="text" id="itemDescription" th:field="*{itemDescription}" readonly>
            <h3><label>Unit Price</label></h3>
            <input type="text" id="unitPrice" th:field="*{unitPrice}" readonly>
            <h3><label>Quantity</label></h3>
            <input type="text" id="quantity" th:field="*{quantity}" readonly>
            <h3><label>Total Amount</label></h3>
            <input type="text" id="totalAmount" th:field="*{totalAmount}" readonly>
        </div>
        <button type="submit" class="submit-btn">Submit invoice</button>
    </form>
</div>

<h2 style="margin-top: 40px;">All Invoices</h2>
<table>
    <thead>
    <tr>
        <th>Invoice Number</th>
        <th>Vendor</th>
        <th>Date</th>
        <th>Item Description</th>
        <th>Unit Price</th>
        <th>Quantity</th>
        <th>Total</th>
        <th>Status</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="invoice : ${invoices}">
        <td th:text="${invoice.invoiceNo}"></td>
        <td th:text="${invoice.vendorName}"></td>
        <td th:text="${invoice.invoiceDate}"></td>
        <td th:text="${invoice.itemDescription}"></td>
        <td th:text="${invoice.unitPrice}"></td>
        <td th:text="${invoice.quantity}"></td>
        <td th:text="${invoice.totalAmount}"></td>
        <td th:text="${invoice.approvalStatus}"></td>
    </tr>
    </tbody>
</table>

<!-- ✅ SCRIPT SECTION -->
<script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.querySelector('.file-name');
    const fileIcon = document.querySelector('.file-icon');
    const alertBox = document.getElementById('alertBox');

    fileInput.addEventListener('change', async function () {
        const file = this.files[0];
        if (!file) return;

        fileName.textContent = file.name;

        let iconClass = "fa-file";
        if (file.type.includes("pdf")) iconClass = "fa-file-pdf";
        else if (file.type.includes("word")) iconClass = "fa-file-word";
        else if (file.type.includes("image")) iconClass = "fa-file-image";
        fileIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;

        const formData = new FormData();
        formData.append("file", file);

        const token = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        try {
            const response = await fetch("/user/invoice/extract", {
                method: "POST",
                body: formData,
                headers: { [header]: token }
            });

            const data = await response.json();
            console.log("✅ Extracted Data:", data);

            if (!response.ok || !data.valid) {
                alertBox.classList.remove("d-none");
                alertBox.classList.add("show");
                alertBox.innerText = "⚠️ Invalid invoice: One or more fields are incomplete.";
                setTimeout(() => alertBox.classList.add("d-none"), 5000);
                return;
            }

            // Hide alert
            alertBox.classList.add("d-none");

            document.getElementById("invoiceNo").value = data.invoiceNo || "";
            document.getElementById("vendorName").value = data.vendorName || "";
            document.getElementById("invoiceDate").value = data.invoiceDate || "";
            document.getElementById("itemDescription").value = data.itemDescription || "";
            document.getElementById("unitPrice").value = data.unitPrice || "";
            document.getElementById("quantity").value = data.quantity || "";
            document.getElementById("totalAmount").value = data.totalAmount || "";

        } catch (error) {
            console.error("❌ Error uploading file:", error);
            alertBox.classList.remove("d-none");
            alertBox.innerText = "There was an error extracting data from the file.";
            setTimeout(() => alertBox.classList.add("d-none"), 5000);
        }
    });
</script>

</body>
</html>
